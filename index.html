<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat</title>
    <!-- Use Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load html2canvas for the share feature -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Load Tone.js for audio feedback -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <!-- Load Inter font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800;900&display=swap">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light default fallback */
            background-image: linear-gradient(to bottom right, #8995a5, #cbd5e1);
            transition: all 0.3s ease;
        }
        .dark body {
            background-color: #1a202c; /* Dark default fallback */
            background-image: linear-gradient(to bottom right, #1f2937, #334155);
        }
        
        .words-container {
            max-height: 400px;
            overflow-y: auto;
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            scrollbar-width: thin;
        }
        .words-container::-webkit-scrollbar {
            width: 8px;
        }
        .words-container::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .dark .words-container::-webkit-scrollbar-thumb {
            background-color: #475569;
        }

        .word {
            display: inline-block;
            margin-right: 0.25rem;
            padding: 0.2rem 0.3rem;
            transition: all 0.15s ease;
            border-radius: 0.25rem;
        }
        
        .word.active {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            padding: 0.25rem 0.5rem;
        }
        .word.correct {
            color: #22c55e; /* Tailwind green-500 */
        }
        .word.incorrect {
            color: #ef4444; /* Tailwind red-500 */
        }
        .dark .word.correct {
            color: #4ade80; /* Tailwind green-400 */
        }
        .dark .word.incorrect {
            color: #f87171; /* Tailwind red-400 */
        }
        
        /* Input field styling for a cleaner look */
        #typing-input {
            border-top-left-radius: 0;
            border-top-right-radius: 0;
            border-top-width: 1px;
            border-color: #e2e8f0;
            box-shadow: none;
        }
        .dark #typing-input {
             border-color: #475569;
        }
        #typing-input:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }

        #wpm-graph {
            background-color: #f1f5f9;
            border-radius: 0.75rem;
            width: 100%;
            height: 150px;
        }
        .dark #wpm-graph {
            background-color: #334155;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-200 to-gray-300 text-gray-800 dark:from-slate-800 dark:to-slate-900 dark:text-slate-100 transition-colors duration-300">

    <div class="min-h-screen p-4 flex flex-col items-center justify-center">
        <div class="container max-w-4xl w-full mx-auto space-y-8">
            <!-- Header with Mode Toggle and Logo -->
            <header class="p-4 rounded-xl shadow-lg flex justify-between items-center bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm">
                <h1 class="text-3xl font-bold font-inter">Simple Typing Test</h1>
                <button id="mode-toggle" class="p-2 rounded-full transition-all duration-300 bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600" aria-label="Toggle dark mode">
                    <!-- Sun icon for light mode, Moon icon for dark mode -->
                    <svg id="sun-icon" class="w-6 h-6 hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>
                    <svg id="moon-icon" class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                </button>
            </header>

            <!-- Main Typing Card -->
            <div class="rounded-xl shadow-lg bg-white/70 dark:bg-slate-800/70 backdrop-blur-sm transition-colors duration-300">
                
                <!-- Time Selection and Stats Header -->
                <div class="p-4 rounded-t-xl flex justify-between items-center bg-slate-100/50 dark:bg-slate-700/50">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-500 dark:text-slate-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2h4"/><path d="M12 14v-4"/><path d="M4 13a8 8 0 1 0 16 0"/><path d="M2 13h2"/><path d="M20 13h2"/><path d="M12 2a10 10 0 0 0 0 20 10 10 0 0 0 0-20z"/></svg>
                        <button data-time="30" class="time-btn px-3 py-1 rounded-full font-bold text-sm transition-all duration-200 bg-blue-500 text-white hover:bg-blue-600">30s</button>
                        <button data-time="60" class="time-btn px-3 py-1 rounded-full font-bold text-sm transition-all duration-200 bg-gray-300 text-gray-800 hover:bg-gray-400 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">60s</button>
                        <button data-time="120" class="time-btn px-3 py-1 rounded-full font-bold text-sm transition-all duration-200 bg-gray-300 text-gray-800 hover:bg-gray-400 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">120s</button>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="timer-display" class="text-2xl font-bold min-w-[50px] text-right text-gray-800 dark:text-slate-200">60s</span>
                    </div>
                </div>

                <!-- Words Display (Chat-like message bubble) -->
                <div id="words-container" class="words-container p-6 text-xl leading-relaxed text-gray-700 dark:text-slate-200">
                    <div id="words-paragraph" class="words-paragraph"></div>
                </div>
                
                <!-- Input and Live Stats -->
                <div class="p-4 flex flex-col md:flex-row items-center gap-4">
                    <input id="typing-input" type="text" class="w-full p-4 rounded-lg text-lg focus:outline-none focus:ring-4 focus:ring-blue-500 transition-all duration-300 bg-gray-50 dark:bg-slate-700 dark:text-slate-100" placeholder="Click a time to start or just start typing..." />
                    
                    <div class="grid grid-cols-2 lg:flex gap-4 w-full md:w-auto">
                        <div class="flex flex-col items-center">
                            <span id="wpm-display" class="text-2xl font-extrabold text-blue-500">0</span>
                            <div class="text-xs uppercase tracking-wider font-semibold opacity-75">WPM</div>
                        </div>
                        <div class="flex flex-col items-center">
                            <span id="accuracy-display" class="text-2xl font-extrabold text-green-500">0%</span>
                            <div class="text-xs uppercase tracking-wider font-semibold opacity-75">Accuracy</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New features: WPM Graph and Word Progress Bar -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                <!-- WPM Graph -->
                <div class="bg-white/70 dark:bg-slate-800/70 p-6 rounded-xl shadow-lg backdrop-blur-sm">
                    <h3 class="text-lg font-bold mb-2 text-center">Live WPM Graph</h3>
                    <canvas id="wpm-graph" class="rounded-lg shadow-inner"></canvas>
                </div>
                <!-- Word Progress -->
                <div class="bg-white/70 dark:bg-slate-800/70 p-6 rounded-xl shadow-lg backdrop-blur-sm">
                    <h3 class="text-lg font-bold mb-2 text-center">Word Progress</h3>
                    <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-8 flex items-center overflow-hidden">
                        <div id="word-progress-bar" class="bg-blue-500 h-full rounded-full transition-all duration-500 flex items-center justify-end pr-2 text-white font-bold" style="width: 0;">0/100</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Modal (initially hidden) -->
    <div id="results-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="results-card" class="p-8 rounded-2xl shadow-2xl text-center space-y-6 transform animate-fade-in bg-white dark:bg-slate-800 dark:text-slate-200">
            <h2 class="text-4xl font-bold text-blue-500">Test Complete!</h2>
            <div class="flex justify-around gap-6">
                <div class="space-y-2">
                    <div id="final-wpm" class="text-6xl font-extrabold">0</div>
                    <div class="uppercase tracking-wider font-semibold opacity-75">Final WPM</div>
                </div>
                <div class="space-y-2">
                    <div id="final-accuracy" class="text-6xl font-extrabold">0%</div>
                    <div class="uppercase tracking-wider font-semibold opacity-75">Accuracy</div>
                </div>
                <div class="space-y-2">
                    <div id="final-errors" class="text-6xl font-extrabold">0</div>
                    <div class="uppercase tracking-wider font-semibold opacity-75">Errors</div>
                </div>
            </div>
            <div class="flex justify-center gap-4 mt-6">
                <button id="restart-btn" class="px-6 py-3 rounded-lg flex items-center gap-2 font-semibold bg-blue-600 text-white hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"/><path d="M21 13a9 9 0 1 1-3-7.7L21 8"/></svg>
                    Restart
                </button>
                <button id="share-btn" class="px-6 py-3 rounded-lg flex items-center gap-2 font-semibold bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><path d="M8.59 13.51l6.83 3.48"/><path d="M15.41 6.49l-6.83 3.48"/></svg>
                    Share
                </button>
            </div>
        </div>
    </div>

    <script>
        // Data and DOM elements
        const wordList = [
            "the", "be", "to", "of", "and", "a", "in", "that", "have", "I", "it", "for", "not", "on", "with", "he", "as", "you", "do", "at", "this", "but", "his", "by", "from", "they", "we", "say", "her", "she", "or", "an", "will", "my", "one", "all", "would", "there", "their", "what", "so", "up", "out", "if", "about", "who", "get", "which", "go", "me", "when", "make", "can", "like", "time", "no", "just", "him", "know", "take", "people", "into", "year", "your", "good", "some", "could", "them", "see", "other", "than", "then", "now", "look", "only", "come", "its", "over", "think", "also", "back", "after", "use", "two", "how", "our", "work", "first", "well", "way", "even", "new", "want", "because", "any", "these", "give", "day", "most", "us", "is", "was", "are", "were", "has", "had", "been",
            "about", "above", "across", "act", "active", "actually", "add", "after", "again", "against", "age", "ago", "agree", "air", "all", "allow", "almost", "alone", "along", "already", "also", "although", "always", "am", "among", "an", "and", "another", "answer", "any", "anyone", "anything", "anywhere", "apply", "are", "area", "argue", "around", "arrive", "art", "as", "ask", "at", "atom", "author", "away", "back", "bad", "ball", "bank", "base", "be", "bear", "beauty", "become", "bed", "before", "begin", "behind", "believe", "bell", "below", "beside", "best", "better", "between", "big", "bird", "bit", "black", "block", "blood", "blue", "board", "boat", "body", "book", "both", "bottom", "box", "boy", "break", "bring", "brother", "build", "burn", "business", "but", "buy", "by", "call", "came", "can", "capital", "car", "card", "care", "carry", "case", "cat", "catch", "cause", "cell", "center", "cent", "century", "certain", "chair", "chance", "change", "character", "charge", "chart", "check", "child", "choose", "city", "class", "clean", "clear", "climb", "clock", "close", "cloud", "coast", "cold", "collect", "colony", "color", "column", "come", "common", "company", "compare", "complete", "condition", "connect", "consider", "consonant", "contain", "continent", "continue", "control", "cook", "cool", "copy", "corn", "correct", "cost", "cotton", "could", "count", "country", "course", "cover", "create", "cross", "crowd", "current", "cut", "dad", "dance", "danger", "dark", "day", "deal", "dear", "decide", "decimal", "deep", "degree", "depend", "describe", "desert", "design", "develop", "diagram", "did", "die", "differ", "difficult", "dinner", "direct", "discover", "distance", "divide", "do", "doctor", "does", "dog", "dollar", "done", "don't", "door", "double", "down", "draw", "dream", "drive", "drop", "dry", "duck", "during", "each", "ear", "early", "earth", "east", "eat", "edge", "editor", "effect", "egg", "eight", "either", "electric", "element", "else", "end", "energy", "engine", "enough", "enter", "equal", "equator", "especially", "even", "evening", "event", "ever", "every", "everyone", "everything", "example", "except", "exist", "expect", "experience", "experiment", "explain", "express", "extra", "eye", "face", "fact", "fair", "fall", "family", "famous", "far", "farm", "fast", "father", "favorite", "fear", "feel", "feet", "few", "field", "figure", "fill", "final", "find", "fine", "finger", "finish", "fire", "first", "fish", "five", "flat", "floor", "flow", "flower", "fly", "follow", "food", "foot", "for", "force", "forest", "form", "forward", "found", "four", "fraction", "free", "fresh", "friend", "from", "front", "fruit", "full", "further", "game", "garden", "gas", "gather", "general", "get", "girl", "give", "glad", "glass", "go", "god", "gold", "gone", "good", "govern", "grand", "grass", "great", "green", "grew", "ground", "group", "grow", "guess", "guide", "gun", "guy", "hair", "half", "hand", "happen", "happy", "hard", "has", "hat", "have", "he", "head", "hear", "heart", "heat", "heavy", "help", "her", "here", "high", "hill", "him", "his", "history", "hit", "hold", "hole", "home", "hope", "horse", "hot", "hotel", "hour", "house", "how", "huge", "human", "hundred", "hunt", "hurry", "husband", "ice", "idea", "if", "imagine", "important", "in", "inch", "include", "increase", "indeed", "index", "indicate", "industry", "information", "inside", "instead", "instrument", "interest", "into", "introduce", "invent", "iron", "is", "island", "it", "its", "job", "join", "joy", "judge", "jump", "just", "keep", "key", "kind", "king", "know", "lady", "lake", "land", "language", "large", "last", "late", "later", "laugh", "law", "lay", "lead", "learn", "least", "leave", "left", "leg", "let", "level", "lie", "life", "lift", "light", "like", "line", "liquid", "list", "listen", "little", "live", "locate", "log", "long", "look", "lose", "lot", "loud", "love", "low", "machine", "made", "main", "major", "make", "man", "many", "map", "mark", "market", "marry", "mass", "master", "match", "material", "matter", "may", "maybe", "me", "mean", "measure", "meet", "member", "men", "metal", "method", "middle", "might", "mile", "milk", "million", "mind", "mine", "minute", "miss", "model", "modern", "moment", "money", "month", "moon", "more", "morning", "most", "mother", "mountain", "mouth", "move", "much", "music", "must", "my", "name", "nation", "nature", "near", "necessary", "need", "never", "new", "next", "night", "no", "noise", "none", "north", "note", "nothing", "notice", "now", "number", "numeral", "object", "observe", "ocean", "of", "off", "offer", "office", "often", "oh", "old", "on", "once", "one", "only", "open", "opposite", "or", "order", "other", "our", "out", "outside", "over", "own", "owner", "oxygen", "page", "pain", "paint", "paper", "paragraph", "parent", "part", "particular", "pass", "past", "path", "pattern", "pay", "people", "perfect", "perhaps", "period", "person", "phrase", "pick", "picture", "piece", "pilot", "pin", "place", "plain", "plan", "planet", "plant", "play", "please", "plural", "poem", "point", "pole", "poor", "populate", "port", "position", "possible", "post", "pound", "power", "practice", "prepare", "present", "press", "pretty", "print", "probable", "problem", "process", "produce", "product", "proper", "property", "protect", "prove", "provide", "pull", "push", "put", "question", "quick", "quiet", "quite", "rabbit", "race", "radio", "rain", "raise", "ran", "range", "rather", "reach", "read", "ready", "real", "reason", "receive", "record", "red", "region", "remember", "repeat", "reply", "represent", "require", "rest", "result", "return", "ride", "right", "river", "road", "rock", "room", "root", "round", "row", "rule", "run", "safe", "said", "sail", "salt", "same", "sand", "sat", "save", "saw", "say", "scale", "school", "science", "sea", "season", "seat", "second", "section", "see", "seed", "seem", "sell", "send", "sense", "sent", "sentence", "separate", "serve", "set", "settle", "seven", "several", "shall", "shape", "share", "sharp", "she", "ship", "shoe", "shop", "short", "should", "shout", "show", "side", "sight", "sign", "silent", "simple", "since", "sing", "single", "sister", "sit", "six", "size", "sky", "sleep", "slip", "slow", "small", "smell", "smile", "snow", "so", "soft", "soil", "soldier", "solution", "some", "someone", "something", "sometimes", "son", "song", "soon", "sound", "south", "space", "speak", "special", "speech", "speed", "spell", "spend", "spoke", "spot", "spread", "spring", "square", "stand", "star", "start", "state", "station", "stay", "steam", "steel", "step", "stick", "still", "stone", "stood", "stop", "store", "story", "straight", "strange", "street", "stretch", "string", "strong", "subject", "substance", "subtract", "success", "such", "sudden", "sugar", "suggest", "suit", "summer", "sun", "supply", "support", "sure", "surface", "surprise", "sweet", "swim", "symbol", "system", "table", "tail", "take", "talk", "tall", "taste", "teach", "team", "tell", "ten", "term", "test", "than", "that", "the", "their", "them", "then", "there", "these", "they", "thing", "think", "third", "this", "those", "though", "thought", "thousand", "three", "through", "throw", "thus", "time", "tiny", "to", "today", "together", "told", "too", "took", "tool", "top", "total", "touch", "toward", "town", "track", "trade", "train", "travel", "tree", "triangle", "trip", "trouble", "truck", "true", "try", "tube", "turn", "twenty", "two", "type", "under", "unit", "until", "up", "upon", "us", "use", "usual", "valley", "value", "various", "verb", "very", "view", "village", "visit", "voice", "vowel", "wait", "walk", "wall", "want", "war", "warm", "was", "wash", "watch", "water", "wave", "way", "we", "wear", "weather", "week", "weight", "well", "went", "were", "west", "what", "whatever", "when", "where", "whether", "which", "while", "white", "who", "whole", "why", "wide", "wife", "will", "win", "wind", "window", "wing", "winter", "wire", "wish", "with", "within", "without", "woman", "wonder", "wood", "word", "work", "world", "would", "write", "wrong", "yard", "yeah", "year", "yes", "yet", "you", "young", "your", "yourself", "zero", "zoo"
        ];
        
        // DOM Elements
        const body = document.body;
        const typingInput = document.getElementById('typing-input');
        const wordsParagraph = document.getElementById('words-paragraph');
        const timerDisplay = document.getElementById('timer-display');
        const timeButtons = document.querySelectorAll('.time-btn');
        const resultsModal = document.getElementById('results-modal');
        const resultsCard = document.getElementById('results-card');
        const restartBtn = document.getElementById('restart-btn');
        const shareBtn = document.getElementById('share-btn');
        const modeToggle = document.getElementById('mode-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const wpmGraphCanvas = document.getElementById('wpm-graph');
        const wordProgressBar = document.getElementById('word-progress-bar');
        
        // Live Stat Displays
        const wpmDisplay = document.getElementById('wpm-display');
        const accuracyDisplay = document.getElementById('accuracy-display');
        
        // Game State Variables
        let timeLimit = 60;
        let words = [];
        let currentWordIndex = 0;
        let typedWord = '';
        let timer = timeLimit;
        let status = 'initial'; // 'initial', 'started', 'finished'
        let timerInterval = null;
        let correctCharsCount = 0;
        let totalTypedChars = 0;
        let totalErrors = 0;
        
        // WPM Graph State
        const wpmHistory = [];
        const wpmGraphCtx = wpmGraphCanvas.getContext('2d');
        
        // Sound effects using Tone.js
        const correctSynth = new Tone.Synth({
            oscillator: { type: 'sine' },
            envelope: {
                attack: 0.01,
                decay: 0.1,
                sustain: 0.1,
                release: 0.1
            }
        }).toDestination();
        const incorrectSynth = new Tone.Synth({
            oscillator: { type: 'sawtooth' },
            envelope: {
                attack: 0.01,
                decay: 0.1,
                sustain: 0.1,
                release: 0.1
            }
        }).toDestination();
        
        // --- Game Logic Functions ---
        
        function initGame() {
            // Reset all state variables
            typedWord = '';
            currentWordIndex = 0;
            correctCharsCount = 0;
            totalTypedChars = 0;
            totalErrors = 0;
            status = 'initial';
            timer = timeLimit;
            wpmHistory.length = 0; // Clear the WPM history
            
            clearInterval(timerInterval);
            
            // Clear existing words and shuffle the list
            wordsParagraph.innerHTML = '';
            const shuffledWords = [...wordList].sort(() => 0.5 - Math.random());
            words = shuffledWords.slice(0, 100);
            
            // Render the new words to the DOM
            words.forEach((word) => {
                const wordSpan = document.createElement('span');
                wordSpan.className = 'word inline-block';
                wordSpan.textContent = word;
                wordsParagraph.appendChild(wordSpan);
                wordsParagraph.appendChild(document.createTextNode(' '));
            });
            
            // Highlight the first word
            wordsParagraph.children[0].classList.add('active');
            
            // Update UI elements
            typingInput.value = '';
            typingInput.disabled = false;
            typingInput.focus();
            timerDisplay.textContent = `${timer}s`;
            wpmDisplay.textContent = '0';
            accuracyDisplay.textContent = '0%';
            updateWordProgressBar();
            drawWPMGraph();
            
            wordsParagraph.children[0].scrollIntoView({ behavior: 'smooth', block: 'center' });

            resultsModal.classList.add('hidden');
        }
        
        function startGame() {
            if (status === 'initial') {
                status = 'started';
                typingInput.placeholder = '';
                // The Tone.js context needs to be started on a user action
                Tone.start(); 
                timerInterval = setInterval(() => {
                    countdown();
                    updateLiveStats();
                    drawWPMGraph();
                }, 1000);
            }
        }
        
        function endGame() {
            status = 'finished';
            clearInterval(timerInterval);
            typingInput.disabled = true;
            
            // Final calculations
            const finalWPM = calculateWPM();
            const finalAccuracy = calculateAccuracy();
            
            // Update final results in the modal
            document.getElementById('final-wpm').textContent = finalWPM;
            document.getElementById('final-accuracy').textContent = `${finalAccuracy}%`;
            document.getElementById('final-errors').textContent = totalErrors;
            
            resultsModal.classList.remove('hidden');
        }
        
        function countdown() {
            timer--;
            timerDisplay.textContent = `${timer}s`;
            if (timer <= 0) {
                endGame();
            }
        }
        
        function updateLiveStats() {
            wpmHistory.push(calculateWPM());
            wpmDisplay.textContent = calculateWPM();
            accuracyDisplay.textContent = `${calculateAccuracy()}%`;
        }
        
        function updateWordProgressBar() {
            const progress = (currentWordIndex / words.length) * 100;
            wordProgressBar.style.width = `${progress}%`;
            wordProgressBar.textContent = `${currentWordIndex}/${words.length}`;
        }
        
        function calculateWPM() {
            const timeElapsed = timeLimit - timer;
            if (timeElapsed <= 0) return 0;
            const wordsTyped = (correctCharsCount / 5);
            return Math.round((wordsTyped / timeElapsed) * 60);
        }
        
        function calculateAccuracy() {
            if (totalTypedChars === 0) return 0;
            return Math.round((correctCharsCount / totalTypedChars) * 100);
        }
        
        function drawWPMGraph() {
            const ctx = wpmGraphCtx;
            const canvas = wpmGraphCanvas;
            const graphWidth = canvas.width;
            const graphHeight = canvas.height;
            
            // Clear the canvas
            ctx.clearRect(0, 0, graphWidth, graphHeight);
            
            if (wpmHistory.length < 2) return;
            
            // Find max WPM for scaling
            const maxWPM = Math.max(...wpmHistory);
            const scaleY = graphHeight / (maxWPM > 0 ? maxWPM : 1);
            const scaleX = graphWidth / (wpmHistory.length - 1);
            
            // Draw the line
            ctx.beginPath();
            ctx.lineWidth = 3;
            ctx.strokeStyle = '#3b82f6'; // Tailwind blue-500
            
            ctx.moveTo(0, graphHeight - wpmHistory[0] * scaleY);
            for (let i = 1; i < wpmHistory.length; i++) {
                ctx.lineTo(i * scaleX, graphHeight - wpmHistory[i] * scaleY);
            }
            ctx.stroke();
            
            // Draw points
            for (let i = 0; i < wpmHistory.length; i++) {
                ctx.beginPath();
                ctx.arc(i * scaleX, graphHeight - wpmHistory[i] * scaleY, 4, 0, 2 * Math.PI);
                ctx.fillStyle = '#3b82f6';
                ctx.fill();
            }
        }
        
        // --- Event Handlers ---
        
        typingInput.addEventListener('keydown', (e) => {
            if (status === 'finished') return;
            
            startGame();
            
            const currentWordSpan = wordsParagraph.children[currentWordIndex];
            const currentWord = words[currentWordIndex];
            
            if (e.key.length === 1 && e.key !== ' ') {
                 // Play correct or incorrect sound
                 if (typedWord.length < currentWord.length && e.key === currentWord[typedWord.length]) {
                     correctSynth.triggerAttackRelease('C5', '8n');
                 } else {
                     incorrectSynth.triggerAttackRelease('F#3', '8n');
                 }
            }

            // Handle Spacebar
            if (e.key === ' ' && typedWord.trim().length > 0) {
                e.preventDefault();
                
                const typed = typedWord.trim();
                let wordErrors = 0;
                
                // Compare typed word with the target word
                for (let i = 0; i < Math.min(typed.length, currentWord.length); i++) {
                    if (typed[i] !== currentWord[i]) {
                        wordErrors++;
                    }
                }
                wordErrors += Math.abs(typed.length - currentWord.length);
                totalErrors += wordErrors;
                totalTypedChars += typed.length;
                
                if (wordErrors === 0) {
                    currentWordSpan.classList.add('correct');
                    correctCharsCount += currentWord.length;
                } else {
                    currentWordSpan.classList.add('incorrect');
                    correctCharsCount += currentWord.length - wordErrors;
                }
                
                // Move to next word
                currentWordSpan.classList.remove('active');
                currentWordIndex++;
                
                if (currentWordIndex < words.length) {
                    wordsParagraph.children[currentWordIndex].classList.add('active');
                    wordsParagraph.children[currentWordIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    endGame();
                }
                
                typedWord = '';
                typingInput.value = '';
                updateLiveStats();
                updateWordProgressBar();
            
            // Handle Backspace
            } else if (e.key === 'Backspace') {
                typedWord = typedWord.slice(0, -1);
            
            // Handle regular characters
            } else if (e.key.length === 1) {
                typedWord += e.key;
            }
        });
        
        // We handle the live character highlighting in the 'input' event for better responsiveness
        typingInput.addEventListener('input', () => {
            if (status === 'finished') return;
            
            const currentWordSpan = wordsParagraph.children[currentWordIndex];
            const currentWord = words[currentWordIndex];
            
            // Update visual feedback for the active word
            let isCorrect = true;
            for (let i = 0; i < typingInput.value.length; i++) {
                if (typingInput.value[i] !== currentWord[i]) {
                    isCorrect = false;
                    break;
                }
            }

            if (isCorrect) {
                currentWordSpan.classList.remove('incorrect');
            } else {
                currentWordSpan.classList.add('incorrect');
            }
        });
        
        // Handle time button clicks
        timeButtons.forEach(button => {
            button.addEventListener('click', () => {
                timeLimit = parseInt(button.dataset.time);
                initGame();
                
                // Update active button styling
                timeButtons.forEach(btn => {
                    const isActive = parseInt(btn.dataset.time) === timeLimit;
                    btn.classList.toggle('bg-blue-500', isActive);
                    btn.classList.toggle('text-white', isActive);
                    btn.classList.toggle('hover:bg-blue-600', isActive);
                    btn.classList.toggle('bg-gray-300', !isActive);
                    btn.classList.toggle('text-gray-800', !isActive);
                    btn.classList.toggle('hover:bg-gray-400', !isActive);
                    btn.classList.toggle('dark:bg-slate-600', !isActive);
                    btn.classList.toggle('dark:text-slate-200', !isActive);
                    btn.classList.toggle('dark:hover:bg-slate-500', !isActive);
                });
            });
        });

        // Handle modal button clicks
        restartBtn.addEventListener('click', () => initGame());
        shareBtn.addEventListener('click', () => {
            if (resultsCard) {
                html2canvas(resultsCard).then(canvas => {
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = 'typing-test-results.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            }
        });

        // Handle dark mode toggle
        function toggleDarkMode() {
            body.classList.toggle('dark');
            const isDarkMode = body.classList.contains('dark');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            
            if (isDarkMode) {
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
        }
        modeToggle.addEventListener('click', toggleDarkMode);
        
        // Check for saved dark mode preference on load
        function checkDarkModePreference() {
            if (localStorage.getItem('darkMode') === 'enabled' || (localStorage.getItem('darkMode') === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                toggleDarkMode();
            }
        }

        // Initialize canvas size on window load and resize
        window.addEventListener('load', () => {
            wpmGraphCanvas.width = wpmGraphCanvas.offsetWidth;
            wpmGraphCanvas.height = wpmGraphCanvas.offsetHeight;
            checkDarkModePreference();
            initGame();
        });
        
        window.addEventListener('resize', () => {
             wpmGraphCanvas.width = wpmGraphCanvas.offsetWidth;
             wpmGraphCanvas.height = wpmGraphCanvas.offsetHeight;
             drawWPMGraph(); // Redraw on resize
        });
    </script>

</body>
</html>
